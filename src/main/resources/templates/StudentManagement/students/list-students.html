<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="'Custom Page Title'">Custom Page Title</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        .card {
            border-radius: 10px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
        }

        .loader {
            display: none;
            margin-left: 10px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>

<!-- Replace the content section -->
<div th:replace="layout/base.html">
    <div th:fragment="content">

        <div class="container mt-5">
            <div class="card p-4">
                <h2 class="mb-4 text-primary">Student Enrollment Selection</h2>

                <form>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Select Department:</label>
                            <div class="d-flex align-items-center">
                                <select class="form-select" id="department" required>
                                    <option value="">--Select Department--</option>
                                    <th:block th:each="department : ${departments}">
                                        <option th:value="${department.id}" th:text="${department.name}"></option>
                                    </th:block>
                                </select>
                                <div class="loader" id="loader-department"></div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Select Course:</label>
                            <div class="d-flex align-items-center">
                                <select class="form-select" id="course" required>
                                    <option value="">--Select Course--</option>
                                </select>
                                <div class="loader" id="loader-course"></div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Select Semester:</label>
                            <div class="d-flex align-items-center">
                                <select class="form-select" id="semester" required>
                                    <option value="">--Select Semester--</option>
                                </select>
                                <div class="loader" id="loader-semester"></div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label class="form-label">Select Division:</label>
                            <div class="d-flex align-items-center">
                                <select class="form-select" id="division" required>
                                    <option value="">--Select Division--</option>
                                </select>
                                <div class="loader" id="loader-division"></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="card p-4 mt-4">
                <h3 class="text-primary">Student List</h3>
                <h4><a href="#" id="downloadLink">Download PDF</a></h4>
                <table class="table table-striped mt-3">
                    <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>Email</th>
                    </tr>
                    </thead>
                    <tbody id="studentTable">
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>
<script>
    function showLoader(id) {
        $("#" + id).show();
    }

    function hideLoader(id) {
        $("#" + id).hide();
    }

    $('#department').change(function () {
        var departmentId = $(this).val();
        if (departmentId) {
            showLoader("loader-department");
            $.get("/admin/students/courses/" + departmentId, function (courses) {
                $('#course').empty().append('<option value="">--Select Course--</option>');
                $.each(courses, function (index, course) {
                    $('#course').append('<option value="' + course.courseID + '">' + course.courseName + '</option>');
                });
                hideLoader("loader-department");
            });
        } else {
            $('#course, #semester, #division').empty().append('<option value="">--Select--</option>');
            $('#studentTable').empty();
        }
    });

    $('#course').change(function () {
        var courseId = $(this).val();
        if (courseId) {
            showLoader("loader-course");
            $.get("/admin/students/semesters/" + courseId, function (semesters) {
                $('#semester').empty().append('<option value="">--Select Semester--</option>');
                $.each(semesters, function (index, semester) {
                    $('#semester').append('<option value="' + semester.id + '">' + semester.name + " - " + semester.academicYear + '</option>');
                });
                hideLoader("loader-course");
            });
        } else {
            $('#semester, #division').empty().append('<option value="">--Select--</option>');
            $('#studentTable').empty();
        }
    });

    $('#semester').change(function () {
        var semesterId = $(this).val();
        if (semesterId) {
            showLoader("loader-semester");
            $.get("/admin/students/divisions/" + semesterId, function (divisions) {
                $('#division').empty().append('<option value="">--Select Division--</option>');
                $.each(divisions, function (index, division) {
                    $('#division').append('<option value="' + division.id + '">' + division.name + '</option>');
                });
                hideLoader("loader-semester");
            });
        } else {
            $('#division').empty().append('<option value="">--Select Division--</option>');
            $('#studentTable').empty();
        }
    });

    $('#division').change(function () {
        var divisionId = $(this).val();
        if (divisionId) {
            showLoader("loader-division");
            $.get("/admin/students/list/" + divisionId, function (students) {
                var tableBody = $('#studentTable');
                tableBody.empty();
                $.each(students, function (index, student) {
                    tableBody.append('<tr>' +
                        '<td>' + student.id + '</td>' +
                        '<td>' + student.firstName + '</td>' +
                        '<td>' + student.lastName + '</td>' +
                        '<td>' + student.email + '</td>' +
                        '</tr>');
                });
                hideLoader("loader-division");

                // Enable the download link when the student data is loaded
                $('#downloadLink').prop('href', '/admin/students/download?divisionId=' + divisionId);
            });
        } else {
            $('#studentTable').empty();
        }
    });
</script>
</body>
</html>
